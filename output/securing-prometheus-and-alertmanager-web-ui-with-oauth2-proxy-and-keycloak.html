<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
<link href="http://gmpg.org/xfn/11" rel="profile"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<!-- Metadata -->
<meta content="How to configure a secure login for your Prometheus and Alertmanger web UI with oauth2-proxy and Keycloak, contains configuration examples" name="description"/>
<meta content="How to configure a secure login for your Prometheus and Alertmanger web UI with oauth2-proxy and Keycloak, contains configuration examples" property="og:description"/>
<meta content="Securing Prometheus and Alertmanager web UI with oauth2-proxy and Keycloak" property="og:title"/>
<meta content="article" property="og:type"/>
<meta content="http://127.0.0.1:8000/securing-prometheus-and-alertmanager-web-ui-with-oauth2-proxy-and-keycloak.html" property="og:url"/>
<meta content="https://max-pfeiffer.github.io/blog/images/2025-02-28_oauth2_proxy_simplified-architecture.svg" property="og:image"/>
<!-- Enable responsiveness on mobile devices-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1" name="viewport">
<title>The Nerdy Tech Blog</title>
<!-- CSS -->
<link href="//fonts.googleapis.com/" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/poole.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/hyde.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/syntax.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" rel="stylesheet">
<!-- Feeds -->
<!-- Analytics -->
</link></meta><meta content="F3nYemi_dYYQckoOJ33wBp5BG4frj27_I6Iiianw594" name="google-site-verification"/><link href="/favicon.ico" rel="icon"/><link href="http://127.0.0.1:8000/securing-prometheus-and-alertmanager-web-ui-with-oauth2-proxy-and-keycloak.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "The Nerdy Tech Blog", "item": "http://127.0.0.1:8000"}, {"@type": "ListItem", "position": 2, "name": "Securing prometheus and alertmanager web ui with oauth2 proxy and keycloak", "item": "http://127.0.0.1:8000/securing-prometheus-and-alertmanager-web-ui-with-oauth2-proxy-and-keycloak.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Max Pfeiffer"}, "publisher": {"@type": "Organization", "name": "The Nerdy Tech Blog", "logo": {"@type": "ImageObject", "url": "https://max-pfeiffer.github.io/blog/images/avatar.jpeg"}}, "headline": "Securing Prometheus and Alertmanager web UI with oauth2-proxy and Keycloak", "about": "misc", "datePublished": "2025-02-28 12:00", "image": "https://max-pfeiffer.github.io/blog/images/2025-02-28_oauth2_proxy_simplified-architecture.svg"}</script></head>
<body class="theme-base-0d">
<div class="sidebar">
<div class="container sidebar-sticky">
<div class="sidebar-about">
<h1>
<a href="http://127.0.0.1:8000/">
<img class="profile-picture" src="http://127.0.0.1:8000/images/avatar.jpeg"/>
					The Nerdy Tech Blog
				</a>
</h1>
<p class="lead"></p>
<p class="lead"> </p>
<p></p>
</div>
<ul class="sidebar-nav">
<li><a href="http://127.0.0.1:8000/pages/about.html">About</a></li>
<li><a href="http://127.0.0.1:8000/pages/imprint.html">Imprint</a></li>
<li><a href="http://127.0.0.1:8000/pages/privacy.html">Privacy</a></li>
</ul>
<nav class="sidebar-social">
<a class="sidebar-social-item" href="https://github.com/max-pfeiffer" target="_blank">
<i class="fa fa-github"></i>
</a>
<a class="sidebar-social-item" href="http://127.0.0.1:8000/">
<i class="fa fa-rss"></i>
</a>
</nav>
<p class="sidebar-footer">Â© 2025 Max Pfeiffer</p>
</div>
</div> <div class="content container">
<div class="post">
<h1 class="post-title">Securing Prometheus and Alertmanager web UI with oauth2-proxy and Keycloak</h1>
<span class="post-date">Fri 28 February 2025</span>
<p><a href="https://prometheus.io/">Prometheus</a> and <a href="https://github.com/prometheus/alertmanager">Alertmanager</a> come with a quite
useful web user interface. But other than <a href="https://grafana.com/">Grafana</a> there is no build in mechanism for user
authentication or authorization. In an <a href="http://127.0.0.1:8000/single-sign-on-sso-with-grafana-and-keycloak.html">earlier article</a> I was
covering that single sign on (SSO) configuration for <a href="https://grafana.com/">Grafana</a> with <a href="https://www.keycloak.org/">Keycloak</a>.
A nice option to configure SSO for <a href="https://prometheus.io/">Prometheus</a> and <a href="https://github.com/prometheus/alertmanager">Alertmanager</a>
is to use the <a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy project</a>.</p>
<p><img alt="2025-02-28_oauth2_proxy_simplified-architecture.svg" src="http://127.0.0.1:8000/images/2025-02-28_oauth2_proxy_simplified-architecture.svg"/>
<em>Image source: <a href="https://github.com/oauth2-proxy/oauth2-proxy/blob/master/docs/static/img/simplified-architecture.svg">https://github.com/oauth2-proxy/oauth2-proxy/blob/master/docs/static/img/simplified-architecture.svg</a></em></p>
<p><a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a> offers two integration options: running it as reverse
proxy or as middleware. In a Kubernetes environment with an ingress controller, it makes much more sense to run it as
middleware and let it just handle the authentication challenges. How that works is well described in
<a href="https://oauth2-proxy.github.io/oauth2-proxy/behaviour">its official documentation</a>.</p>
<h2>Preliminary rulings</h2>
<p>For doing the configuration, we need to do some decisions first:</p>
<ol>
<li>ingress configuration for Prometheus and Altermanager: on what domains or URL paths would we like to run these applications</li>
<li><a href="https://oauth2-proxy.github.io/oauth2-proxy/#architecture">oauth2-proxy integration</a>: reverse proxy or middleware (see above)</li>
<li><a href="https://oauth2-proxy.github.io/oauth2-proxy/configuration/session_storage">oauth2-proxy session storage</a>: cookie or Redis</li>
</ol>
<h3>Ingress configuration decision</h3>
<p>It's quite common to run Prometheus and Alertmanager (and also Grafana) on a single monitoring domain with different
paths, i.e.:</p>
<ul>
<li>monitoring.yourcompany.com/prometheus</li>
<li>monitoring.yourcompany.com/alertmanager</li>
<li>monitoring.yourcompany.com/grafana</li>
</ul>
<p>This is done for good reasons:</p>
<ul>
<li>you just need to have one domain for your cluster's monitoring</li>
<li>that way you just need to configure and run a single instance of oauth2-proxy, oauth2-proxy is just not made for
  covering multiple domains with a single installation.</li>
<li>permission configuration: permission concept for users is usually bound equally to the Kube-Prometheus stack applications</li>
<li>it's convenient for users to access the different applications in this manner</li>
</ul>
<p>So we will follow that common approach and use one domain and different URL paths for the applications.
We will set it up like this:</p>
<ul>
<li>monitoring.lan/prometheus</li>
<li>monitoring.lan/alertmanager</li>
</ul>
<h3>oauth2-proxy integration decision</h3>
<p>In a Kubernetes environment you usually run an ingress controller handling the incoming network traffic. In my case,
I use the <a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a>. There you have
<a href="https://oauth2-proxy.github.io/oauth2-proxy/configuration/integration#configuring-for-use-with-the-nginx-auth_request-directive">good options to forward authentication requests to oauth2-proxy using the <code>auth_request</code> directive</a>
and use it as middleware. So we go for this option as it is very flexible and easy to configure with ingress
annotations.</p>
<h3>oauth2-proxy session storage decision</h3>
<p>oauth2-proxy has two options for storing the session information for authenticated users: in a cookie or in
<a href="https://redis.io/">Redis database</a>. Actually <a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a> has problems
looping through large cookies in headers and requires some sophisticated configuration to make that work.
Storing the session information in <a href="https://redis.io/">Redis database</a> is in overall a more solid solution and avoids
additional network payload. But it uses additional Kubernetes computing resources and consumes storage (if persisted).
But the Redis variant is easy and convenient to configure using the 
<a href="https://github.com/oauth2-proxy/manifests">Helm chart for oauth2-proxy</a>. So I decided to go with this solution.</p>
<h2>Keycloak configuration</h2>
<p>I assume that you have a running <a href="https://www.keycloak.org/">Keycloak</a> installation in your Kubernetes cluster. In an
earlier article, I was covering the <a href="http://127.0.0.1:8000/how-to-configure-keycloak-terraform-provider-for-automated-provisioning.html">automated provisioning of Keycloak with OpenTofu</a>.
That might be interesting if you still need to set that up.</p>
<p>In Keycloak we need to configure:</p>
<ul>
<li>a role for resource authorization, let's call it <code>monitoring</code></li>
<li>a confidential client for oauth2-proxy</li>
<li>an OpenID audience protocol mapper for that oauth2-proxy client </li>
</ul>
<p>A complete configuration for <a href="https://opentofu.org/">OpenTofu</a> will look like this:</p>
<div class="highlight"><pre><span></span><code><span class="kr">resource</span><span class="w"> </span><span class="nc">"keycloak_openid_client"</span><span class="w"> </span><span class="nv">"oauth2_proxy"</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">realm_id</span><span class="w">                     </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_realm.homelab.id</span>
<span class="w">  </span><span class="na">client_id</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="s2">"oauth2-proxy"</span>
<span class="w">  </span><span class="na">name</span><span class="w">                         </span><span class="o">=</span><span class="w"> </span><span class="s2">"Oauth2 Proxy Client"</span>
<span class="w">  </span><span class="na">enabled</span><span class="w">                      </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">access_type</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="s2">"CONFIDENTIAL"</span>
<span class="w">  </span><span class="na">client_secret</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">"yoursecret"</span>
<span class="w">  </span><span class="na">standard_flow_enabled</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">direct_access_grants_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">false</span>

<span class="w">  </span><span class="na">valid_redirect_uris</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">"https://monitoring.lan/oauth2/callback"</span>
<span class="w">  </span><span class="p">]</span>
<span class="w">  </span><span class="na">valid_post_logout_redirect_uris</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">"+"</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"keycloak_openid_audience_protocol_mapper"</span><span class="w"> </span><span class="nv">"oauth2_proxy"</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">client_id</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_openid_client.oauth2_proxy.id</span>
<span class="w">  </span><span class="na">realm_id</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_realm.homelab.id</span>
<span class="w">  </span><span class="na">name</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">"audience-mapper"</span>
<span class="w">  </span><span class="na">included_client_audience</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_openid_client.oauth2_proxy.client_id</span>
<span class="w">  </span><span class="na">add_to_access_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">add_to_id_token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">"keycloak_role"</span><span class="w"> </span><span class="nv">"realm_homelab_client_oauth2_proxy_role_alertmanager"</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">realm_id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_realm.homelab.id</span>
<span class="w">  </span><span class="na">client_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">keycloak_openid_client.oauth2_proxy.id</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">"monitoring"</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Grants access to monitoring"</span>
<span class="p">}</span>
</code></pre></div>
<p>After this configuration is done you can create a user and assign that <code>monitoring</code> role to him.</p>
<h2>Ingress controller configuration</h2>
<p>We need to configure two separate ingresses for Prometheus and Alermanager. I installed these two applications using
the <a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">kube-prometheus-stack</a> Helm chart. You can configure the ingress for both applications in the Helm chart
via the <code>values.yaml</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="nt">alertmanager</span><span class="p">:</span>
<span class="w">  </span><span class="nt">alertmanagerSpec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">externalUrl</span><span class="p">:</span><span class="w"> </span><span class="s">"https://monitoring.lan/alertmanager"</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="s">"nginx"</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">step-issuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StepClusterIssuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certmanager.step.sm</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-response-headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Authorization</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-signin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://$host/oauth2/start?rd=$escaped_request_uri</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://$host/oauth2/auth</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/$2</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/alertmanager(/|$)(.*)"</span>
<span class="w">    </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">    </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>
<span class="w">    </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="s">"alertmanager-lan-tls"</span>
<span class="w">        </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>

<span class="nt">prometheus</span><span class="p">:</span>
<span class="w">  </span><span class="nt">prometheusSpec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">externalUrl</span><span class="p">:</span><span class="w"> </span><span class="s">"https://monitoring.lan/prometheus"</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">ingressClassName</span><span class="p">:</span><span class="w"> </span><span class="s">"nginx"</span>
<span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">step-issuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StepClusterIssuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certmanager.step.sm</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-response-headers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Authorization</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-signin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://$host/oauth2/start?rd=$escaped_request_uri</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/auth-url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://$host/oauth2/auth</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/$2</span>
<span class="w">    </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>
<span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"/prometheus(/|$)(.*)"</span>
<span class="w">    </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">    </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="s">"prometheus-lan-tls"</span>
<span class="w">        </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>
</code></pre></div>
<p>There you see the ingress annotations for oauth2-proxy. Also, you get an idea how to use the
<code>nginx.ingress.kubernetes.io/rewrite-target</code> annotation to make that URL path configuration for both applications work.
Please note that <code>externalUrl</code> is an application-specific setting and specifies the path for the applications to run on.</p>
<h2>oauth2-proxy installation and configuration</h2>
<p>There is a <a href="https://github.com/oauth2-proxy/manifests">Helm chart for oauth2-proxy</a> which is well maintained by the
community. I used without any issues to install <a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a> in my
Kubernetes cluster.</p>
<p>The <a href="https://oauth2-proxy.github.io/oauth2-proxy/configuration/providers/keycloak_oidc">Keycloak integration is well documented</a>
and straight forward. As you are actually doing the configuration in the <code>values.yaml</code> file for
<a href="https://github.com/oauth2-proxy/manifests">oauth2-proxy Helm chart</a> you need to 'translate" <code>-</code> into <code>_</code> for the
configuration option keys <a href="https://oauth2-proxy.github.io/oauth2-proxy/configuration/overview">as also described in the docs</a>.</p>
<p>I ended up with this <code>values.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">config</span><span class="p">:</span>
<span class="w">  </span><span class="nt">clientID</span><span class="p">:</span><span class="w"> </span><span class="s">"oauth2_proxy_client_id"</span>
<span class="w">  </span><span class="nt">clientSecret</span><span class="p">:</span><span class="w"> </span><span class="s">"oauth2_proxy_client_secret"</span>
<span class="w">  </span><span class="nt">configFile</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no"># Provider Config</span>
<span class="w">    </span><span class="no">provider = "keycloak-oidc"</span>
<span class="w">    </span><span class="no">provider_display_name = "Keycloak"</span>
<span class="w">    </span><span class="no">redirect_url = "https://monitoring.lan/oauth2/callback"</span>
<span class="w">    </span><span class="no">oidc_issuer_url = "https://keycloak.lan/realms/homelab"</span>
<span class="w">    </span><span class="no">code_challenge_method = "S256"</span>

<span class="w">    </span><span class="no"># Server Config</span>
<span class="w">    </span><span class="no">reverse_proxy = true</span>
<span class="w">    </span><span class="no">cookie_secure = true</span>
<span class="w">    </span><span class="no">email_domains = [ "*" ]</span>
<span class="w">    </span><span class="no">allowed_roles = [ "oauth2-proxy:monitoring" ]</span>

<span class="w">    </span><span class="no"># Add root CA certificate</span>
<span class="w">    </span><span class="no">provider_ca_files = [ "/etc/ssl/certs/root_ca_certificate" ]</span>

<span class="nt">extraVolumes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root-ca</span>
<span class="w">    </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oauth-proxy-ca</span>

<span class="nt">extraVolumeMounts</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root-ca</span>
<span class="w">    </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">"/etc/ssl/certs"</span>
<span class="w">    </span><span class="nt">defaultMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0440</span>
<span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">redis</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">global</span><span class="p">:</span>
<span class="w">    </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">"oauth2_proxy_redis_password"</span>
<span class="nt">sessionStorage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">"oauth2_proxy_redis_password"</span>

<span class="nt">ingress</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">className</span><span class="p">:</span><span class="w"> </span><span class="s">"nginx"</span>
<span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">"/oauth2"</span>
<span class="w">  </span><span class="nt">pathType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prefix</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">step-issuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StepClusterIssuer</span>
<span class="w">      </span><span class="nt">cert-manager.io/issuer-group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certmanager.step.sm</span>
<span class="w">      </span><span class="nt">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
<span class="w">  </span><span class="nt">tls</span><span class="p">:</span>
<span class="w">   </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oauth2-proxy-tls</span>
<span class="w">     </span><span class="nt">hosts</span><span class="p">:</span>
<span class="w">       </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"monitoring.lan"</span>
</code></pre></div>
<p>Please note that I use <a href="http://127.0.0.1:8000/how-to-bootstrap-a-certificate-authority-in-your-kubernetes-cluster.html">a custom certificate authority (CA)</a>
here (<code>provider_ca_files</code>). For ingesting the root certificate I also added <code>extraVolumes</code> and <code>extraVolumeMounts</code>.
You will not need that unless you also use a custom CA for your Kubernetes cluster.</p>
<p>With this last step you should have a working oauth2-proxy installation and should be able to sign in with a user you
have configured in Keycloak. Don't forget to assign the <code>monitoring</code> role to that user. </p>
</div>
</div>
</body>
</html>