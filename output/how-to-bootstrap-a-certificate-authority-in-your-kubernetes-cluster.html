<!DOCTYPE html>

<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
<link href="http://gmpg.org/xfn/11" rel="profile"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<!-- Metadata -->
<meta content="A guide for bootstrapping a certificate authority for issuing TLS certificates in a Kubernetes cluster" name="description"/>
<meta content="A guide for bootstrapping a certificate authority for issuing TLS certificates in a Kubernetes cluster" property="og:description"/>
<meta content="How to Bootstrap a Certificate Authority in your Kubernetes Cluster" property="og:title"/>
<meta content="article" property="og:type"/>
<meta content="http://127.0.0.1:8000/how-to-bootstrap-a-certificate-authority-in-your-kubernetes-cluster.html" property="og:url"/>
<meta content="https://max-pfeiffer.github.io/blog/images/2025-01-20_bootstrap_certificate_authority.jpeg" property="og:image"/>
<!-- Enable responsiveness on mobile devices-->
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1" name="viewport">
<title>The Nerdy Tech Blog</title>
<!-- CSS -->
<link href="//fonts.googleapis.com/" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/poole.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/hyde.css" rel="stylesheet"/>
<link href="http://127.0.0.1:8000/theme/css/syntax.css" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" rel="stylesheet">
<!-- Feeds -->
<!-- Analytics -->
</link></meta><meta content="F3nYemi_dYYQckoOJ33wBp5BG4frj27_I6Iiianw594" name="google-site-verification"/><link href="/favicon.ico" rel="icon"/><link href="http://127.0.0.1:8000/how-to-bootstrap-a-certificate-authority-in-your-kubernetes-cluster.html" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "The Nerdy Tech Blog", "item": "http://127.0.0.1:8000"}, {"@type": "ListItem", "position": 2, "name": "How to bootstrap a certificate authority in your kubernetes cluster", "item": "http://127.0.0.1:8000/how-to-bootstrap-a-certificate-authority-in-your-kubernetes-cluster.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Max Pfeiffer"}, "publisher": {"@type": "Organization", "name": "The Nerdy Tech Blog", "logo": {"@type": "ImageObject", "url": "https://max-pfeiffer.github.io/blog/images/avatar.jpeg"}}, "headline": "How to Bootstrap a Certificate Authority in your Kubernetes Cluster", "about": "misc", "datePublished": "2025-01-20 21:00", "image": "https://max-pfeiffer.github.io/blog/images/2025-01-20_bootstrap_certificate_authority.jpeg"}</script></head>
<body class="theme-base-0d">
<div class="sidebar">
<div class="container sidebar-sticky">
<div class="sidebar-about">
<h1>
<a href="http://127.0.0.1:8000/">
<img class="profile-picture" src="http://127.0.0.1:8000/images/avatar.jpeg"/>
					The Nerdy Tech Blog
				</a>
</h1>
<p class="lead"></p>
<p class="lead"> </p>
<p></p>
</div>
<ul class="sidebar-nav">
<li><a href="http://127.0.0.1:8000/pages/about.html">About</a></li>
<li><a href="http://127.0.0.1:8000/pages/imprint.html">Imprint</a></li>
<li><a href="http://127.0.0.1:8000/pages/privacy.html">Privacy</a></li>
</ul>
<nav class="sidebar-social">
<a class="sidebar-social-item" href="https://github.com/max-pfeiffer" target="_blank">
<i class="fa fa-github"></i>
</a>
<a class="sidebar-social-item" href="http://127.0.0.1:8000/">
<i class="fa fa-rss"></i>
</a>
</nav>
<p class="sidebar-footer">Â© 2025 Max Pfeiffer</p>
</div>
</div> <div class="content container">
<div class="post">
<h1 class="post-title">How to Bootstrap a Certificate Authority in your Kubernetes Cluster</h1>
<span class="post-date">Mon 20 January 2025</span>
<p>In overall, I was a bit unhappy using self-signed TLS certificates in my home lab Kubernetes cluster. I found it
annoying to click away these warnings in my browser. Also, I ran into a couple of problems using self-signed
certificates for my <a href="https://www.keycloak.org/">Keycloak</a> installation. When configuring SSO for
<a href="https://argoproj.github.io/cd/">ArgoCD</a> and <a href="https://grafana.com/">Grafana</a> I had to configure security overrides when
calling Keycloak OIDC endpoints for the authentication process. So I decided to create my owm certificate authority
eventually.</p>
<p>A friend recommended the solution from <a href="https://smallstep.com/">Smallstep</a> to me. These guys provide
<a href="https://github.com/smallstep/certificates">Step CA</a> which is a piece of software which issues TLS certificates
based on your own root certificate authority (CA). They also provide
<a href="https://github.com/smallstep/step-issuer">Step Issuer</a> which is a Kubernetes <a href="https://cert-manager.io">cert-manager</a>
<a href="https://cert-manager.io/docs/usage/certificaterequest">CertificateRequest</a> controller that uses
<a href="https://github.com/smallstep/certificates">Step CA</a>.</p>
<p><img alt="Smallstep GitHub Organisation" src="http://127.0.0.1:8000/images/2025-01-20_bootstrap_certificate_authority.jpeg"/></p>
<p>Installing <a href="https://github.com/smallstep/certificates">Step CA</a> and <a href="https://github.com/smallstep/step-issuer">Step Issuer</a>
und configuring Ingresses with it, I fell into a couple of traps. So that process was not as straight forward as I
 thought, and I spent a while on a working solution. So I guess it's worth sharing my experience with the public.</p>
<h2>Step CA</h2>
<p>I was using the <a href="https://artifacthub.io/packages/helm/smallstep/step-certificates">Helm chart to install Step CA</a>.
As a first step you want to create your <code>values.yaml</code> file.
<a href="https://github.com/smallstep/cli">Smallstep offers a CLI tool</a> which comes in handy here. It's quickly
<a href="https://smallstep.com/docs/step-cli/installation/">installed</a> on your machine. You can generate your <code>values.yaml</code>
like so:</p>
<div class="highlight"><pre><span></span><code>step<span class="w"> </span>ca<span class="w"> </span>init<span class="w"> </span>--helm<span class="w"> </span>&gt;<span class="w"> </span>values.yaml
</code></pre></div>
<p>This will result in some interactive process where you need to enter the following configuration options:</p>
<ol>
<li>Deployment Type: you want to select <code>Standalone</code> here</li>
<li>Name od the PKI: pick something that suits you</li>
<li>DNS names: here you need to have a FQDN for:</li>
<li>cert-manager (mandatory): this needs to be some FQDN that your
      <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/">internal Kubernetes DNS can resolve</a>,
      i.e. <code>step-certificates.security.svc.cluster.local</code> or <code>step-certificates.cert</code> <strong>depending on the namespace you
      will install it into</strong></li>
<li>the outside world: if you choose to offer that service on some public domain i.e. <code>ca.yourdomain.com</code></li>
<li>IP and port: go with the default <code>:9000</code> or pick whatever matches your use case</li>
<li>First provisioner name: as we are aiming for cert-manager using it, <code>cert-manager</code> is probably a good choice</li>
<li>Password: when you generate one, it ends up base64encoded in that <code>values.yaml</code> file</li>
</ol>
<p>Depending on how you conduct the installation process with Helm, you might want to remove the password and
certificates, keep it in your credential store and inject it later with your provisioning tool. I use
<a href="https://opentofu.org/">OpenTofu</a> for this. A simple install using Helm CLI can be done like this:</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>smallstep<span class="w"> </span>https://smallstep.github.io/helm-charts/
helm<span class="w"> </span>install<span class="w"> </span>step-certificates<span class="w"> </span>smallstep/certificates<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>--namespace<span class="w"> </span>security
</code></pre></div>
<p>Please be aware of the <code>security</code> namespace. This will result in Step Certificates being available under the FQDN
<code>step-certificates.security.svc.cluster.local</code> in your Kubernetes cluster. As you probably don't want to install and
run it in your default namespace, this is this first trap you can fall into.</p>
<h3>Results</h3>
<p>Now check for ConfigMaps created by that Helm chart:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap
NAME<span class="w">                       </span>DATA<span class="w">   </span>AGE
kube-root-ca.crt<span class="w">           </span><span class="m">1</span><span class="w">      </span>42h
step-certificates-certs<span class="w">    </span><span class="m">2</span><span class="w">      </span>42h
step-certificates-config<span class="w">   </span><span class="m">4</span><span class="w">      </span>42h
</code></pre></div>
<p>And have a closer look at that <code>step-certificates-certs</code> ConfigMap:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-certs<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<p>Take note that includes the root_ca certificate. This will come in handy later.</p>
<p>Also check on the <code>step-certificates-config</code> ConfigMap:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-config<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<p>Take note that it includes the configuration for the provisioner that we generated with the
<a href="(https://github.com/smallstep/cli)">Step CLI tool</a> earlier. We will need that later to configure the
<a href="https://github.com/smallstep/step-issuer">Step Issuer</a>.</p>
<p>Check on the Secrets which were created by the Helm chart:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>secret<span class="w">                                   </span>
NAME<span class="w">                                      </span>TYPE<span class="w">                                 </span>DATA<span class="w">   </span>AGE
sh.helm.release.v1.step-certificates.v1<span class="w">   </span>helm.sh/release.v1<span class="w">                   </span><span class="m">1</span><span class="w">      </span>42h
step-certificates-ca-password<span class="w">             </span>smallstep.com/ca-password<span class="w">            </span><span class="m">1</span><span class="w">      </span>42h
step-certificates-provisioner-password<span class="w">    </span>smallstep.com/provisioner-password<span class="w">   </span><span class="m">1</span><span class="w">      </span>42h
step-certificates-secrets<span class="w">                 </span>smallstep.com/private-keys<span class="w">           </span><span class="m">2</span><span class="w">      </span>42h
</code></pre></div>
<p>Take not that there is a secret containing the provisioner password <code>step-certificates-provisioner-password</code>. This
we also need to configure the <a href="https://github.com/smallstep/step-issuer">Step Issuer</a>.</p>
<h2>Step Issuer</h2>
<p>Smallstep provides another <a href="https://artifacthub.io/packages/helm/smallstep/step-issuer">Helm chart to install Step Issuer</a>.
I wanted to have a ClusterIssuer for my Kubernetes Cluster. Fortunately, that Helm chart comes with a template to
create it. But for configuring it, we need the following seven values:</p>
<ol>
<li>CA URL</li>
<li>CA Root certificate (base64 encoded)</li>
<li>Provisioner name</li>
<li>Provisioner Key ID (KID)</li>
<li>From the provisioner Secret (see above <code>step-certificates-provisioner-password</code>)</li>
<li>Name of the Secret</li>
<li>Key of the password in that Secret</li>
<li>Namespace where that Secret lives</li>
</ol>
<p>For extracting the necessary values, you need to have <a href="https://jqlang.github.io/jq/">jq</a> installed. </p>
<p>CA URL can be extracted from <code>step-certificates-config</code> ConfigMap (see above):</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-config<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['defaults\.json']}"</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'."ca-url"'</span>
</code></pre></div>
<p>CA root certificate can be extracted from <code>step-certificates-certs</code> ConfigMap (see above) and encode it with base64:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-certs<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['root_ca\.crt']}"</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>base64
</code></pre></div>
<p>Extract provisioner name from <code>step-certificates-config</code> ConfigMap (see above) like so:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-config<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['ca\.json']}"</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'.authority.provisioners[0].name'</span>
</code></pre></div>
<p>Extract provisioner KID from <code>step-certificates-config</code> ConfigMap (see above) like so:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>-n<span class="w"> </span>security<span class="w"> </span>get<span class="w"> </span>configmap<span class="w"> </span>step-certificates-config<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s2">"{.data['ca\.json']}"</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'.authority.provisioners[0].key.kid'</span>
</code></pre></div>
<p>With the values you acquired, you can put together your <code>values.yaml</code> file for
<a href="https://artifacthub.io/packages/helm/smallstep/step-issuer">Step Issuer Helm chart</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">stepClusterIssuer</span><span class="p">:</span>
<span class="w">  </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">caUrl</span><span class="p">:</span><span class="w"> </span><span class="s">"https://step-certificates.security.svc.cluster.local"</span>
<span class="w">  </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s">"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJvekNDQVVxZ0F3SUJBZ0lSQU5zTnFuNGNLb0JYN3RLMDFPU"</span>
<span class="w">  </span><span class="nt">provisioner</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"cert-manager"</span>
<span class="w">    </span><span class="nt">kid</span><span class="p">:</span><span class="w"> </span><span class="s">"KCE2Wd2sJB-3adZZpPueITNIe8KyXw0Om17-kDzZ_fQ"</span>
<span class="w">    </span><span class="nt">passwordRef</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"step-certificates-provisioner-password"</span>
<span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">"password"</span>
<span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">"security"</span>
</code></pre></div>
<p>Then use that <code>values.yaml</code> file to install Step Issuer in your Kubernetes cluster:</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>step-issuer<span class="w"> </span>smallstep/step-issuer<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>--namespace<span class="w"> </span>security
</code></pre></div>
<h3>Results</h3>
<p>Check the results after installation:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$kubectl</span><span class="w"> </span>get<span class="w"> </span>stepclusterissuer<span class="w">        </span>
NAME<span class="w">          </span>AGE
step-issuer<span class="w">   </span>3d3h
</code></pre></div>
<p>So you should now have a StepClusterIssuer up and running. Please note that its name is <strong>step-issuer</strong> and not
<strong>step-cluster-issuer</strong>. You need that name to reference it later in the Ingress annotations. For some reason, I don't
understand the Helm chart does not provide any way to change that. Also check its status:</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>stepclusterissuer<span class="w"> </span>step-issuer<span class="w"> </span>-o<span class="w"> </span>yaml
</code></pre></div>
<p>If there is any problem with it, you would see it in the output.</p>
<h2>cert-manager</h2>
<p>You have your StepClusterIssuer up and running now. So cert-manger can use it for issuing TLS certificates. Dealing
with cert-manager Ingress annotations for external issuers is a bit tricky though. Please take note of <a href="https://cert-manager.io/docs/usage/ingress/#supported-annotations">all the
warnings in official cert-manager documentation</a>.
So you want to have the annotations part for an Ingress look like this:</p>
<div class="highlight"><pre><span></span><code>apiVersion:<span class="w"> </span>networking.k8s.io/v1
kind:<span class="w"> </span>Ingress
metadata:
<span class="w">  </span>annotations:
<span class="w">    </span>cert-manager.io/issuer:<span class="w"> </span>step-issuer
<span class="w">    </span>cert-manager.io/issuer-group:<span class="w"> </span>certmanager.step.sm
<span class="w">    </span>cert-manager.io/issuer-kind:<span class="w"> </span>StepClusterIssuer
</code></pre></div>
<p>Please note that <code>cert-manager.io/issuer</code> refers to the name of the StepClusterIssuer <code>step-issuer</code> (see above).</p>
<h2>Import Root CA</h2>
<p>You want to install your new root certificate in your systems trust store eventually. So browsers and other
applications can deal with TLS certificates issued based on that root certificate appropriately. So it makes sense to
put your new root certificate into a file i.e. <code>root-ca.pem</code> that you can use and share.</p>
<h3>Local Machines</h3>
<p><a href="https://github.com/smallstep/cli">Step CLI tool</a> offers a <a href="https://smallstep.com/docs/step-cli/reference/certificate/install/index.html">very convenient way to install the root certificate into
your local default trust store</a>:</p>
<div class="highlight"><pre><span></span><code>step<span class="w"> </span>certificate<span class="w"> </span>install<span class="w"> </span>root-ca.pem
</code></pre></div>
<h3>SSO with Keycloak for ArgoCD</h3>
<p>ArgoCD offers <a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management/#configuring-a-custom-root-ca-certificate-for-communicating-with-the-oidc-provider">a nice configuration option for using custom root certificates</a>:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nt">oidc.config</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">...</span>
<span class="w">    </span><span class="no">rootCA: |</span>
<span class="w">      </span><span class="no">-----BEGIN CERTIFICATE-----</span>
<span class="w">      </span><span class="no">... encoded certificate data here ...</span>
<span class="w">      </span><span class="no">-----END CERTIFICATE-----</span>
</code></pre></div>
<h3>SSO with Keycloak and Grafana</h3>
<p>Grafana is also offering <a href="https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/generic-oauth/#configuration-options">a configuration option for custom root certificates</a>.
Please see <code>tls_client_ca</code> in that section.</p>
<h2>Related Articles</h2>
<ul>
<li><a href="http://127.0.0.1:8000/single-sign-on-sso-with-grafana-and-keycloak.html">Single Sign On (SSO) with Grafana and Keycloak</a></li>
<li><a href="http://127.0.0.1:8000/securing-prometheus-and-alertmanager-web-ui-with-oauth2-proxy-and-keycloak.html">Securing Prometheus and Alertmanager web UI with oauth2-proxy and Keycloak</a></li>
</ul>
</div>
</div>
</body>
</html>